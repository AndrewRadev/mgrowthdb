{% from 'utils/_dataframe.html' import render_dataframe %}
{% from 'utils/_strain_link.html' import render_strain_link %}

{% macro render_results_list(studies, search, offset) %}
  {% if studies|length == 0: %}
    <p class="help">
      Couldn't find a study with these parameters.
    </p>
  {% endif %}

  {% for study in studies: %}
    <li class="js-search-result">
      <div class="search-study">
        <h3 class="flex-row flex-gap-10">
          <a href="{{ url_for('study_show_page', publicId=study.publicId) }}">
            {{ study.nameWithId|highlight(search.query_words) }}
          </a>

          <div class="flex-row flex-right flex-gap-10">
            {% if not study.isPublished: %}
              <span
                  class="icon icon-invisible flex-end"
                  data-tooltip="This study is not published yet. You're seeing it because you uploaded it, you have permission to manage it, or you're an admin.">
              </span>
            {% endif %}

            {% if study.manageable_by_user(g.current_user): %}
              <span
                  class="icon icon-tool flex-end"
                  data-tooltip="You are able to manage this study, either because you uploaded it or because you've given someone the right to edit it.">
              </span>
            {% endif %}
          </div>
        </h3>

        {% if study.description: %}
          {{ study.description|highlight(search.query_words)|format_text(first_paragraph=True, p_class="small") }}
        {% endif %}

        <p class="small">
          {% if study.url and study.url != '': %}
            <strong>Publication</strong>:
            {{ study.url|external_link() }}

            {% if study.authors: %}
              by {{ study.authors|author_link_list(query_words=search.query_words, limit=10) }}
            {% endif %}
          {% endif %}
        </p>

        <p class="small">
          {% if study.studyTechniques: %}
            <strong>Measurement techniques</strong>:
            {{ study.studyTechniques|map(attribute="short_name")|unique|join(", ") }}
            <br>
          {% endif %}

          {% set model_info_list = study.get_model_info_list() %}

          {% if model_info_list: %}
            <strong>Modeling techniques</strong>:
            {{ model_info_list|map(attribute="name")|unique|join(", ") }}
            <br>
          {% endif %}
        </p>

        <table class="simple-table margin-top-10 small">
          <tr>
            {% if study.strains: %}
              <th>Strains</th>
            {% endif %}

            {% if study.metabolites: %}
              <th>Metabolites</th>
            {% endif %}
          </tr>

          <tr>
            {% if study.strains: %}
              <td>
                <ul>
                  {% for strain in study.strains if strain.notUnknown: %}
                    <li class="{{ 'highlight' if strain.ncbiId in search.ncbiIds else '' }}">
                      {{ render_strain_link(strain) }}
                    </li>
                  {% endfor %}
                </ul>
              </td>
            {% endif %}

            {% if study.metabolites: %}
              <td>
                <ul>
                  {% for metabolite in study.metabolites: %}
                    <li class="{{ 'highlight' if metabolite.chebiId in search.chebiIds else '' }}">
                      <a href="{{ url_for('metabolite_show_page', chebiId=metabolite.chebiId) }}">
                        {{ metabolite.name }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </td>
            {% endif %}
          </tr>
        </table>
      </div>
    </li>
  {% endfor %}

  {% if search.has_more: %}
    <a href="#" class="white-button load-more js-load-more">
      Load more
    </a>
  {% endif %}
{% endmacro %}
