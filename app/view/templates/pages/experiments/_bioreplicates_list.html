{% macro render_bioreplicates_list(experiment) %}
  {% set study = experiment.study %}

  <ol class="bioreplicates-list">
    {% for bioreplicate in experiment.bioreplicates %}
      {% set measurement_context_ids = bioreplicate.measurementContexts|map(attribute="id")|list %}

      <li>
        <strong>{{ bioreplicate.name }}</strong>

        <span class="js-compare-container" data-context-ids="{{ measurement_context_ids|join(',') }}">
          <span class="js-compare" data-tooltip="Compare">
            <a href="#" class="white-button no-border small-button">â†”</a>
          </span>

          <span class="js-uncompare hidden" data-tooltip="Comparing, click to remove from comparison">
            ðŸ‘†
            <a href="#" class="white-button no-border small-button">âž–</a>
          </span>
        </span>

        {% set visualize_url = url_for(
          'study_visualize_page',
          publicId=study.publicId,
          selectedExperimentId=experiment.publicId,
          l=measurement_context_ids|join(',')
        ) %}

        <a
            href="{{ visualize_url }}"
            class="white-button no-border small-button"
            data-tooltip="Visualize">
          ðŸ“ˆ
        </a>

        <a
            href="{{ url_for('bioreplicate_csv', id=bioreplicate.id) }}"
            class="white-button no-border small-button"
            style="vertical-align: top"
            download="bioreplicate_{{ bioreplicate.id }}.csv"
            data-tooltip="Download data">
          <span class="flex-row icon icon-download-black"></span>
        </a>

        <br>

        {% for subject_type, measurement_contexts in bioreplicate.measurementContexts|stable_groupby('subjectType'): %}
          <strong class="small">
            {% if subject_type == 'bioreplicate': %}
              Community-level measurements
            {% elif subject_type == 'strain': %}
              Strain-level measurements
            {% elif subject_type == 'metabolite': %}
              Metabolite measurements
            {% endif %}
          </strong>

          <ul class="measurement-techniques">
            {% for measurement_context in measurement_contexts: %}
              <li class="measurement-context-container">
                {% set measurements = measurement_context.measurements %}
                {% set technique    = measurement_context.technique %}

                <div class="js-table-row">
                  <span class="js-compare-container" data-context-ids="{{ measurement_context.id }}">
                    <span class="js-compare" data-tooltip="Compare">
                      <a href="#" class="white-button no-border small-button">â†”</a>
                    </span>

                    <span class="js-uncompare hidden" data-tooltip="Comparing, click to remove from comparison">
                      ðŸ‘†
                      <a href="#" class="white-button no-border small-button">âž–</a>
                    </span>
                  </span>

                  <a
                      href="{{ url_for('study_visualize_page', publicId=study.publicId, l=measurement_context.id) }}"
                      class="white-button no-border small-button"
                      data-tooltip="Visualize">
                    ðŸ“ˆ
                  </a>

                  {{ measurement_context.get_chart_label() }}

                  <a
                      href="{{ url_for('measurement_context_csv', id=measurement_context.id, withLabel=1) }}"
                      class="white-button no-border small-button"
                      style="vertical-align: top"
                      download="measurement_context_{{ measurement_context.id }}.csv"
                      data-tooltip="Download data">
                    <span class="flex-row icon icon-download-black"></span>
                  </a>
                </div>

                {% if measurement_context.publishedModelingResults: %}
                  <h4 class="small">Models:</h4>

                  <ul class="small">
                    {% for modeling_result in measurement_context.publishedModelingResults: %}
                      <li>
                        <span class="js-compare-container" data-model-ids="{{ modeling_result.id }}">
                          <span class="js-compare" data-tooltip="Compare">
                            <a href="#" class="white-button no-border small-button">â†”</a>
                          </span>

                          <span class="js-uncompare hidden" data-tooltip="Comparing, click to remove from comparison">
                            ðŸ‘†
                            <a href="#" class="white-button no-border small-button">âž–</a>
                          </span>
                        </span>

                        {% set visualize_url = url_for(
                          'study_visualize_page',
                          publicId=study.publicId,
                          selectedExperimentId=experiment.publicId,
                          selectedTechniqueId=technique.id,
                          l=measurement_context.id,
                          lm=modeling_result.id
                        ) %}

                        <a
                            href="{{ visualize_url }}"
                            class="white-button no-border small-button"
                            data-tooltip="Visualize">
                          ðŸ“ˆ
                        </a>

                        {{ modeling_result.model_name }}
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endfor %}
      </li>
    {% endfor %}
  </ol>

{% endmacro %}
